#!/bin/bash
# --------------------------------------------------
# Script : update_repos.sh
# Auteur : didhacktic
# Description : Commit + Pull + Push automatiques
# pour les dÃ©pÃ´ts GitHub dans ~/didhacktic
# Compatible sparse-checkout et SSH
# --------------------------------------------------

# Liste des dÃ©pÃ´ts Ã  mettre Ã  jour
REPOS=(
  "mydotfiles-public"
  "mydotfiles-private"
)

# RÃ©pertoire de base
BASE_DIR="$HOME/didhacktic"

# Date du commit
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# Boucle principale
for repo in "${REPOS[@]}"; do
    echo "-------------------------------------------"
    echo "ğŸ“ DÃ©pÃ´t : $repo"
    cd "$BASE_DIR/$repo" || { echo "âš ï¸  Impossible d'accÃ©der Ã  $repo"; continue; }

    # Si sparse-checkout actif, on s'assure que le dossier principal est bien inclus
    if git config --worktree --get core.sparseCheckoutCone &>/dev/null; then
        MAIN_DIR=$(git sparse-checkout list | head -n 1)
        if [[ -n "$MAIN_DIR" ]]; then
            git sparse-checkout set "$MAIN_DIR" >/dev/null 2>&1
        fi
    fi

    # Synchronisation avec GitHub
    echo "ğŸ”„ Synchronisation avec GitHub..."
    git pull --rebase --autostash

    # Ajoute tous les changements (nouveaux fichiers inclus)
    git add -A

    # VÃ©rifie s'il y a quelque chose Ã  commit
    if ! git diff --cached --quiet; then
        echo "ğŸ“ Changements dÃ©tectÃ©s, crÃ©ation du commit..."
        git commit -m "Auto-update: ${DATE}"
        git push
        echo "âœ… Changements envoyÃ©s sur GitHub."
    else
        echo "âœ… Aucun changement local Ã  valider."
    fi

    echo "-------------------------------------------"
    echo
done

echo "ğŸ‰ Tous les dÃ©pÃ´ts sont Ã  jour !"
