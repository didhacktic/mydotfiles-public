#!/usr/bin/env bash
# Nettoie les liens symboliques cassés créés par Stow
# Ignore certains répertoires (snap, Steam, mozilla, etc.) et la corbeille

set -euo pipefail

TRASH_DIR="$HOME/.local/share/Trash/files"

echo "🔍 Recherche des liens symboliques cassés (en excluant certains dossiers)..."

BROKEN_LINKS=$(find "$HOME" -xtype l \
  ! -path "*/snap/*" \
  ! -path "*/Steam/*" \
  ! -path "*/steamrt64/*" \
  ! -path "*/.mozilla/*" \
  ! -path "*/.thunderbird/*" \
  ! -path "$TRASH_DIR/*" \
  ! -name "lock" 2>/dev/null)

if [ -z "$BROKEN_LINKS" ]; then
  echo "✅ Aucun lien symbolique cassé trouvé."
  exit 0
fi

echo "❌ Liens symboliques cassés détectés :"
echo "$BROKEN_LINKS"
echo

read -rp "🧽 Supprimer ces liens ? [y/N] " confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  echo "$BROKEN_LINKS" | while read -r link; do
    rm -v "$link"
  done
  echo "✅ Nettoyage terminé."
else
  echo "🚫 Nettoyage annulé."
fi

