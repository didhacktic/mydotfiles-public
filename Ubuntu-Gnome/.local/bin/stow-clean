#!/usr/bin/env bash
# Nettoie les liens symboliques cassÃ©s crÃ©Ã©s par Stow
# Ignore certains rÃ©pertoires (snap, Steam, mozilla, etc.) et la corbeille

set -euo pipefail

TRASH_DIR="$HOME/.local/share/Trash/files"

echo "ğŸ” Recherche des liens symboliques cassÃ©s (en excluant certains dossiers)..."

BROKEN_LINKS=$(find "$HOME" -xtype l \
  ! -path "*/snap/*" \
  ! -path "*/Steam/*" \
  ! -path "*/steamrt64/*" \
  ! -path "*/.mozilla/*" \
  ! -path "*/.thunderbird/*" \
  ! -path "$TRASH_DIR/*" \
  ! -name "lock" 2>/dev/null)

if [ -z "$BROKEN_LINKS" ]; then
  echo "âœ… Aucun lien symbolique cassÃ© trouvÃ©."
  exit 0
fi

echo "âŒ Liens symboliques cassÃ©s dÃ©tectÃ©s :"
echo "$BROKEN_LINKS"
echo

read -rp "ğŸ§½ Supprimer ces liens ? [y/N] " confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  echo "$BROKEN_LINKS" | while read -r link; do
    rm -v "$link"
  done
  echo "âœ… Nettoyage terminÃ©."
else
  echo "ğŸš« Nettoyage annulÃ©."
fi

